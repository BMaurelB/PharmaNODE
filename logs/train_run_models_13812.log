/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchvision/io/image.py:14: UserWarning: Failed to load image Python extension: 'dlopen(/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchvision/image.so, 0x0006): Library not loaded: @rpath/libjpeg.9.dylib
  Referenced from: <367D4265-B20F-34BD-94EB-4F3EE47C385B> /opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchvision/image.so
  Reason: tried: '/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchvision/../../../libjpeg.9.dylib' (no such file), '/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchvision/../../../libjpeg.9.dylib' (no such file), '/opt/miniconda3/envs/NODE_test/lib/python3.12/lib-dynload/../../libjpeg.9.dylib' (no such file), '/opt/miniconda3/envs/NODE_test/bin/../lib/libjpeg.9.dylib' (no such file)'If you don't plan on using image functionality from `torchvision.io`, you can ignore this warning. Otherwise, there might be something wrong with your environment. Did you have `libjpeg` or `libpng` installed before building `torchvision` from source?
  warn(
/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/read_tacro.py:342: FutureWarning: DataFrame.applymap has been deprecated. Use DataFrame.map instead.
  df = df.applymap(lambda x: str(x).replace(",", ".") if isinstance(x, str) else x)
/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/read_tacro.py:342: FutureWarning: DataFrame.applymap has been deprecated. Use DataFrame.map instead.
  df = df.applymap(lambda x: str(x).replace(",", ".") if isinstance(x, str) else x)
/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/plotting.py:316: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown
  plt.show(block=False)
/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/run_models.py
run_models.py --niters 5000 -n 200 -s 40 -l 10 --dataset PK_Tacro --latent-ode --viz --noise-weight 0.01 --max-t 5. --seed 51 --experiment 13812
Experiment 13812
Epoch 0001 [Test seq (cond on sampled tp)] | Loss 156.693878 | Likelihood -161.631760 | KL fp 1.9316 | FP STD 0.1071|
KL coef: 0.0
Train loss (one batch): 238.10305786132812
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0331
Test MSE (smoothed with alpha=0.01): 0.0331
New best smoothed test MSE: 0.0331. Saving best model to experiments/experiment_13812_best.ckpt
Test MSE group_0: 0.0086
Test MSE group_1: 0.0479
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0191
train MSE group_1: 0.0685
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0002 [Test seq (cond on sampled tp)] | Loss 22096.878906 | Likelihood -22682.626953 | KL fp 1.6704 | FP STD 0.5809|
KL coef: 0.0
Train loss (one batch): 142.69448852539062
Train CE loss (one batch): 0.0
Test MSE (raw): 4.5373
Test MSE (smoothed with alpha=0.01): 0.0781
Smoothed Test MSE did not improve. Early stopping counter: 1/10000
Test MSE group_0: 4.0316
Test MSE group_1: 7.3130
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0084
train MSE group_1: 0.0461
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0003 [Test seq (cond on sampled tp)] | Loss 2035.955078 | Likelihood -2129.888916 | KL fp 1.6345 | FP STD 0.1607|
KL coef: 0.0
Train loss (one batch): 19507.751953125
Train CE loss (one batch): 0.0
Test MSE (raw): 0.4267
Test MSE (smoothed with alpha=0.01): 0.0816
Smoothed Test MSE did not improve. Early stopping counter: 2/10000
Test MSE group_0: 0.1806
Test MSE group_1: 0.8332
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 3.5767
train MSE group_1: 7.2738
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0004 [Test seq (cond on sampled tp)] | Loss 208.856918 | Likelihood -219.109924 | KL fp 2.4426 | FP STD 0.0777|
KL coef: 0.0
Train loss (one batch): 1823.15234375
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0446
Test MSE (smoothed with alpha=0.01): 0.0812
Smoothed Test MSE did not improve. Early stopping counter: 3/10000
Test MSE group_0: 0.0159
Test MSE group_1: 0.0613
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.1465
train MSE group_1: 0.9123
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0005 [Test seq (cond on sampled tp)] | Loss 186.428879 | Likelihood -188.418747 | KL fp 2.3230 | FP STD 0.1000|
KL coef: 0.0
Train loss (one batch): 198.0439910888672
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0384
Test MSE (smoothed with alpha=0.01): 0.0808
Smoothed Test MSE did not improve. Early stopping counter: 4/10000
Test MSE group_0: 0.0119
Test MSE group_1: 0.0448
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0171
train MSE group_1: 0.0588
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0006 [Test seq (cond on sampled tp)] | Loss 188.736526 | Likelihood -190.885880 | KL fp 2.1816 | FP STD 0.1169|
KL coef: 0.0
Train loss (one batch): 175.1147918701172
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0389
Test MSE (smoothed with alpha=0.01): 0.0804
Smoothed Test MSE did not improve. Early stopping counter: 5/10000
Test MSE group_0: 0.0113
Test MSE group_1: 0.0457
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0132
train MSE group_1: 0.0403
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0007 [Test seq (cond on sampled tp)] | Loss 184.372025 | Likelihood -188.036209 | KL fp 2.1568 | FP STD 0.1261|
KL coef: 0.0
Train loss (one batch): 176.13621520996094
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0383
Test MSE (smoothed with alpha=0.01): 0.0800
Smoothed Test MSE did not improve. Early stopping counter: 6/10000
Test MSE group_0: 0.0109
Test MSE group_1: 0.0451
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0131
train MSE group_1: 0.0410
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0008 [Test seq (cond on sampled tp)] | Loss 180.773071 | Likelihood -182.970322 | KL fp 2.0717 | FP STD 0.1319|
KL coef: 0.0
Train loss (one batch): 173.5610809326172
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0373
Test MSE (smoothed with alpha=0.01): 0.0795
Smoothed Test MSE did not improve. Early stopping counter: 7/10000
Test MSE group_0: 0.0106
Test MSE group_1: 0.0439
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0123
train MSE group_1: 0.0406
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0009 [Test seq (cond on sampled tp)] | Loss 171.769180 | Likelihood -174.834518 | KL fp 2.0183 | FP STD 0.1349|
KL coef: 0.0
Train loss (one batch): 169.43846130371094
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0357
Test MSE (smoothed with alpha=0.01): 0.0791
Smoothed Test MSE did not improve. Early stopping counter: 8/10000
Test MSE group_0: 0.0092
Test MSE group_1: 0.0424
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0114
train MSE group_1: 0.0395
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0010 [Test seq (cond on sampled tp)] | Loss 160.011292 | Likelihood -162.125565 | KL fp 1.9636 | FP STD 0.1367|
KL coef: 0.0
Train loss (one batch): 158.7922821044922
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0332
Test MSE (smoothed with alpha=0.01): 0.0786
Smoothed Test MSE did not improve. Early stopping counter: 9/10000
Test MSE group_0: 0.0080
Test MSE group_1: 0.0395
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0107
train MSE group_1: 0.0373
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0011 [Test seq (cond on sampled tp)] | Loss 144.740997 | Likelihood -148.280869 | KL fp 1.9008 | FP STD 0.1379|
KL coef: 0.010000000000000009
Train loss (one batch): 149.85684204101562
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0304
Test MSE (smoothed with alpha=0.01): 0.0781
Smoothed Test MSE did not improve. Early stopping counter: 10/10000
Test MSE group_0: 0.0069
Test MSE group_1: 0.0364
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0095
train MSE group_1: 0.0355
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0012 [Test seq (cond on sampled tp)] | Loss 132.552719 | Likelihood -134.378433 | KL fp 1.8652 | FP STD 0.1392|
KL coef: 0.01990000000000003
Train loss (one batch): 135.67860412597656
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0276
Test MSE (smoothed with alpha=0.01): 0.0776
Smoothed Test MSE did not improve. Early stopping counter: 11/10000
Test MSE group_0: 0.0057
Test MSE group_1: 0.0333
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0083
train MSE group_1: 0.0324
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0013 [Test seq (cond on sampled tp)] | Loss 120.871521 | Likelihood -123.441505 | KL fp 1.8693 | FP STD 0.1411|
KL coef: 0.029700999999999977
Train loss (one batch): 123.89252471923828
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0254
Test MSE (smoothed with alpha=0.01): 0.0771
Smoothed Test MSE did not improve. Early stopping counter: 12/10000
Test MSE group_0: 0.0051
Test MSE group_1: 0.0308
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0072
train MSE group_1: 0.0298
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0014 [Test seq (cond on sampled tp)] | Loss 103.581039 | Likelihood -107.783424 | KL fp 1.7083 | FP STD 0.1442|
KL coef: 0.039403990000000055
Train loss (one batch): 112.01653289794922
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0223
Test MSE (smoothed with alpha=0.01): 0.0766
Smoothed Test MSE did not improve. Early stopping counter: 13/10000
Test MSE group_0: 0.0038
Test MSE group_1: 0.0273
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0063
train MSE group_1: 0.0272
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0015 [Test seq (cond on sampled tp)] | Loss 92.601479 | Likelihood -95.142792 | KL fp 1.6603 | FP STD 0.1477|
KL coef: 0.04900995010000009
Train loss (one batch): 96.20305633544922
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0198
Test MSE (smoothed with alpha=0.01): 0.0760
Smoothed Test MSE did not improve. Early stopping counter: 14/10000
Test MSE group_0: 0.0035
Test MSE group_1: 0.0242
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0051
train MSE group_1: 0.0239
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Experiment 13812
Epoch 0016 [Test seq (cond on sampled tp)] | Loss 83.684212 | Likelihood -84.990486 | KL fp 1.6597 | FP STD 0.1512|
KL coef: 0.058519850599
Train loss (one batch): 84.73750305175781
Train CE loss (one batch): 0.0
Test MSE (raw): 0.0177
Test MSE (smoothed with alpha=0.01): 0.0754
Smoothed Test MSE did not improve. Early stopping counter: 15/10000
Test MSE group_0: 0.0033
Test MSE group_1: 0.0218
Test MSE group_2: nan
Test MSE group_3: nan
Poisson likelihood: 0.0
CE loss: 0.0
train MSE group_0: 0.0046
train MSE group_1: 0.0213
train MSE group_2: nan
train MSE group_3: nan
CE loss (TEST): 0.0
Couldn't import umap
Sampling dataset of 200 training examples
############## ['31031', '1211', '2551', '3741', '1321', '2750', '2250', '1841', '2150', '1231', '31051', '11121', '1651', '3341', '11111', '1151', '11011', '2441', '1750', '2350', '2231', '3611', '2141', '3751', '3311', '3950', '31011', '3411', '2421', '1650', '750', '1541', '950', '11741', '3421', '3151', '1611']
182
TensorBoard logs will be saved to: experiments/runs/13812
Traceback (most recent call last):
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/run_models.py", line 287, in <module>
    train_res = model.compute_all_losses(batch_dict, n_traj_samples = 3, kl_coef = kl_coef)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/base_models.py", line 262, in compute_all_losses
    pred_y, info = self.get_reconstruction(batch_dict["tp_to_predict"], 
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/latent_ode.py", line 71, in get_reconstruction
    first_point_mu, first_point_std = self.encoder_z0(
                                      ^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/encoder_decoder.py", line 228, in forward
    last_yi, last_yi_std, _, extra_info = self.run_odernn(
                                          ^^^^^^^^^^^^^^^^
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/encoder_decoder.py", line 290, in run_odernn
    ode_sol = self.z0_diffeq_solver(prev_y, time_points)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/diffeq_solver.py", line 40, in forward
    pred_y = odeint(self.ode_func, first_point, time_steps_to_predict, 
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchdiffeq/_impl/odeint.py", line 80, in odeint
    solution = solver.integrate(t)
               ^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchdiffeq/_impl/solvers.py", line 114, in integrate
    dy, f0 = self._step_func(self.func, t0, dt, t1, y0)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchdiffeq/_impl/fixed_grid.py", line 10, in _step_func
    f0 = func(t0, y0, perturb=Perturb.NEXT if self.perturb else Perturb.NONE)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchdiffeq/_impl/misc.py", line 197, in forward
    return self.base_func(t, y)
           ^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torchdiffeq/_impl/misc.py", line 165, in forward
    return self.mul * self.base_func(-t, y)
                      ^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/ode_func.py", line 36, in forward
    grad = self.get_ode_gradient_nn(t_local, y)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/benjaminmaurel/Documents/Training_Sanofi/notebooks_hands_on/latent_ode/lib/ode_func.py", line 42, in get_ode_gradient_nn
    return self.gradient_net(y)
           ^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/container.py", line 250, in forward
    input = module(input)
            ^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1736, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1747, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/miniconda3/envs/NODE_test/lib/python3.12/site-packages/torch/nn/modules/linear.py", line 125, in forward
    return F.linear(input, self.weight, self.bias)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
KeyboardInterrupt
